<?php
/**
 * @file
 * Code for the Drush Webservice Server feature.
 */

include_once 'drush_webservice_server.features.inc';

/**
 * Implements hook_permission().
 */
function drush_webservice_server_permission() {
  return array(
    'use drush webservice' => array(
      'title' => 'Execute a command using Drush Webservice',
    ),
  );
}

/**
 * Implements hook_services_resources().
 */
function drush_webservice_server_services_resources() {
  return array(
    'drush' => array(
      'actions' => array(
        'execute' => array(
          'callback' => '_drush_webservice_server_execute',
          'access arguments' => array('use drush webservice'),
          'help' => t('Execute a Drush command.'),
          'args' => array(
            array(
              'name' => 'command',
              'optional' => FALSE,
              'source' => 'data',
              'description' => t('The Drush command to execute.'),
              'type' => 'string',
            ),
          ),
        ),
      ),
    ),
  );
}

/**
 * Webservice callback.
 *
 * Execute a Drush command and return output.
 */
function _drush_webservice_server_execute($command) {
  // TODO status report = warning if drush not in libraries
  // TODO dep = libraries
  // TODO use libraries API
  $drush = '/var/www/d7_features/sites/all/libraries/drush/drush.php';
  //TODO drush_escapeshellarg()
  ob_start();
  print shell_exec("$drush $command --drush-webservice=y 2>&1");
  return ob_get_clean();
}

// TODO see txt file on desktop
// TODO set perm
// TODO test on windows
